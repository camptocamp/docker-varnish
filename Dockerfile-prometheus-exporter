FROM golang:1.14.10 as builder

RUN set -x \
 && cd src \
 && git clone https://github.com/jonnenauha/prometheus_varnish_exporter.git \
 && cd prometheus_varnish_exporter \
 && git fetch origin pull/64/head \
 && git checkout 46fa8a3f800d8cc2e0c95d0582aee50602f53633 \
 && ./build.sh 1.5.2+varnish_6.5

# /!\ KEEP THE BASE IMAGE IN SYNC ACROSS ALL DOCKERFILES /!\
FROM varnish:7.1.1

# ARG PROMETHEUS_EXPORTER_RELEASE=1.5.2
# ARG PROMETHEUS_EXPORTER_CHECKSUM=3ee8c4c59aea1c341b9f4750950f24c8e6d9670ae39ed44af273f08ea318ede8

# RUN set -x \
#  && apt-get update \
#  && apt-get -y install curl \
#  && tmp=$(mktemp -d) \
#  && cd $tmp \
#  && curl -sLo prometheus_varnish_exporter.tar.gz https://github.com/jonnenauha/prometheus_varnish_exporter/releases/download/$PROMETHEUS_EXPORTER_RELEASE/prometheus_varnish_exporter-$PROMETHEUS_EXPORTER_RELEASE.linux-amd64.tar.gz \
#  && echo $PROMETHEUS_EXPORTER_CHECKSUM  prometheus_varnish_exporter.tar.gz | sha256sum -c \
#  && tar -xzvf prometheus_varnish_exporter.tar.gz prometheus_varnish_exporter-$PROMETHEUS_EXPORTER_RELEASE.linux-amd64/prometheus_varnish_exporter \
#  && mv prometheus_varnish_exporter-$PROMETHEUS_EXPORTER_RELEASE.linux-amd64/prometheus_varnish_exporter /usr/local/bin \
#  && chmod +x /usr/local/bin/prometheus_varnish_exporter \
#  && cd \
#  && rm -rf $tmp \
#  && apt-get clean \
#  && rm -rf /var/lib/apt/lists/* \
#  && unset PROMETHEUS_EXPORTER_RELEASE \
#  && unset PROMETHEUS_EXPORTER_CHECKSUM

COPY --from=builder /go/src/prometheus_varnish_exporter/bin/build/prometheus_varnish_exporter-1.5.2+varnish_6.5.linux-amd64/prometheus_varnish_exporter /usr/local/bin/

ENTRYPOINT [ "/usr/local/bin/prometheus_varnish_exporter" ]
